<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voicednut Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            line-height: 1.4;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f8f8f8);
            border-radius: 12px;
        }

        .user-info {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-link-color, #007AFF);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #d0d0d0);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #d0d0d0);
            border-radius: 8px;
            font-size: 14px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f8f8);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            opacity: 0.8;
        }

        .activity-item {
            padding: 12px;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .activity-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .activity-subtitle {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .activity-time {
            font-size: 11px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .error {
            color: #ff3b30;
            background: #ffebee;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }

        .success {
            color: #28a745;
            background: #d4edda;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: var(--tg-theme-section-bg-color, #f0f0f0);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .admin-badge {
            background: #ff9500;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-online {
            background: #34c759;
        }

        .status-offline {
            background: #ff3b30;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéôÔ∏è Voicednut Bot</h1>
            <div id="userInfo" class="user-info">
                <div class="loading">Loading user info...</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div id="totalCalls" class="stat-number">-</div>
                <div class="stat-label">Total Calls</div>
            </div>
            <div class="stat-card">
                <div id="totalSms" class="stat-number">-</div>
                <div class="stat-label">Total SMS</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="call">üìû Call</div>
            <div class="tab" data-tab="sms">üí¨ SMS</div>
            <div class="tab" data-tab="activity">üìã Activity</div>
        </div>

        <!-- Call Tab -->
        <div id="callTab" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Voice Call</h2>
                <div id="callForm">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="callPhone" class="form-input" placeholder="+1234567890" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AI Agent Behavior</label>
                        <textarea id="callPrompt" class="form-textarea" placeholder="Describe how the AI should behave during the call..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">First Message</label>
                        <textarea id="callMessage" class="form-textarea" placeholder="What the AI should say first..." required></textarea>
                    </div>
                    <button id="callButton" class="btn btn-primary">üìû Make Call</button>
                </div>
            </div>
        </div>

        <!-- SMS Tab -->
        <div id="smsTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">Send SMS</h2>
                <div id="smsForm">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="smsPhone" class="form-input" placeholder="+1234567890" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea id="smsMessage" class="form-textarea" placeholder="Your SMS message..." required maxlength="1600"></textarea>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">
                            <span id="smsCharCount">0</span>/1600 characters
                        </div>
                    </div>
                    <button id="smsButton" class="btn btn-primary">üì± Send SMS</button>
                </div>
            </div>
        </div>

        <!-- Activity Tab -->
        <div id="activityTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">Recent Activity</h2>
                <div id="activityList">
                    <div class="loading">Loading activity...</div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusContainer"></div>
    </div>

    <script>
        // Initialize Telegram Web App
        let tg = window.Telegram.WebApp;
        let initData = tg.initData || 'demo';
        let user = null;

        // Get base URL from current location
        const BASE_URL = window.location.origin;
        console.log('Base URL:', BASE_URL);

        // Telegram Web App setup
        tg.expand();
        tg.ready();

        // Global state
        let userData = null;
        let userStats = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupFormHandlers();
            loadUserData();
            loadStats();
            loadActivity();
        });

        // Tab functionality
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabName + 'Tab').classList.add('active');

                    // Load data when switching to activity tab
                    if (tabName === 'activity') {
                        loadActivity();
                    }
                });
            });
        }

        // Form handlers
        function setupFormHandlers() {
            // Call form
            document.getElementById('callButton').addEventListener('click', handleCall);
            
            // SMS form
            document.getElementById('smsButton').addEventListener('click', handleSMS);
            
            // SMS character counter
            const smsTextarea = document.getElementById('smsMessage');
            const charCount = document.getElementById('smsCharCount');
            smsTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }

        // Load user data
        async function loadUserData() {
            try {
                console.log('Loading user data...');
                
                // Extract user info from initData or use demo
                if (initData && initData !== 'demo') {
                    const urlParams = new URLSearchParams(initData);
                    const userParam = urlParams.get('user');
                    if (userParam) {
                        try {
                            user = JSON.parse(decodeURIComponent(userParam));
                            console.log('User from initData:', user);
                        } catch (e) {
                            console.warn('Failed to parse user from initData:', e);
                        }
                    }
                }

                // Fallback to demo user
                if (!user) {
                    user = {
                        id: 'demo',
                        username: 'demo_user',
                        first_name: 'Demo',
                        last_name: 'User'
                    };
                    console.log('Using demo user:', user);
                }

                // Load additional user data from API
                const response = await fetch(`${BASE_URL}/api/user/${user.id}`);
                if (response.ok) {
                    userData = await response.json();
                    console.log('User data from API:', userData);
                } else {
                    console.warn('Failed to load user data from API, using initData only');
                    userData = user;
                }

                updateUserInfo();
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user information');
                
                // Use fallback
                userData = {
                    id: 'demo',
                    username: 'demo_user',
                    first_name: 'Demo',
                    last_name: 'User',
                    role: 'USER',
                    isAdmin: false
                };
                updateUserInfo();
            }
        }

        // Update user info display
        function updateUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
            const username = userData.username ? `@${userData.username}` : '';
            const displayName = fullName || username || `User ${userData.id}`;
            
            let statusHtml = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span class="status-indicator status-online"></span>
                    <strong>${displayName}</strong>
                </div>
            `;
            
            if (userData.isAdmin) {
                statusHtml += `<div style="margin-top: 4px;"><span class="admin-badge">Admin</span></div>`;
            }
            
            statusHtml += `<div style="font-size: 12px; margin-top: 4px; opacity: 0.7;">ID: ${userData.id}</div>`;
            
            userInfoDiv.innerHTML = statusHtml;
        }

        // Load user statistics
        async function loadStats() {
            try {
                console.log('Loading stats for user:', userData?.id || 'demo');
                
                const response = await fetch(`${BASE_URL}/api/user-stats/${userData?.id || 'demo'}`);
                if (response.ok) {
                    userStats = await response.json();
                    console.log('User stats:', userStats);
                    updateStatsDisplay();
                } else {
                    throw new Error(`Stats API returned ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                // Show default stats
                userStats = { total_calls: 0, total_sms: 0 };
                updateStatsDisplay();
            }
        }

        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('totalCalls').textContent = userStats.total_calls || 0;
            document.getElementById('totalSms').textContent = userStats.total_sms || 0;
        }

        // Load recent activity
        async function loadActivity() {
            const activityList = document.getElementById('activityList');
            
            try {
                activityList.innerHTML = '<div class="loading">Loading activity...</div>';
                
                console.log('Loading activity for user:', userData?.id || 'demo');
                
                const response = await fetch(`${BASE_URL}/api/user-activity/${userData?.id || 'demo'}?limit=10`);
                if (!response.ok) {
                    throw new Error(`Activity API returned ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Activity data:', data);
                
                const activities = data.activities || [];
                
                if (activities.length === 0) {
                    activityList.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 20px;">No recent activity</div>';
                    return;
                }

                let activityHtml = '';
                activities.forEach(activity => {
                    const icon = activity.type === 'call' ? 'üìû' : 'üí¨';
                    const status = activity.status === 'completed' ? '‚úÖ' : 
                                  activity.status === 'failed' ? '‚ùå' : 
                                  activity.status === 'delivered' ? '‚úÖ' : '‚è≥';
                    
                    activityHtml += `
                        <div class="activity-item">
                            <div class="activity-title">${icon} ${activity.type === 'call' ? 'Voice Call' : 'SMS'} to ${activity.phone_number}</div>
                            <div class="activity-subtitle">${status} ${activity.status}${activity.duration ? ` ‚Ä¢ ${formatDuration(activity.duration)}` : ''}</div>
                            <div class="activity-time">${formatTimeAgo(activity.created_at)}</div>
                        </div>
                    `;
                });
                
                activityList.innerHTML = activityHtml;
            } catch (error) {
                console.error('Error loading activity:', error);
                activityList.innerHTML = '<div class="error">Failed to load recent activity</div>';
            }
        }

        // Handle call request
        async function handleCall() {
            const button = document.getElementById('callButton');
            const phone = document.getElementById('callPhone').value.trim();
            const prompt = document.getElementById('callPrompt').value.trim();
            const firstMessage = document.getElementById('callMessage').value.trim();

            // Validation
            if (!phone || !prompt || !firstMessage) {
                showError('Please fill in all fields');
                return;
            }

            if (!isValidPhone(phone)) {
                showError('Please enter a valid phone number in E.164 format (e.g., +1234567890)');
                return;
            }

            if (prompt.length < 10) {
                showError('AI behavior description must be at least 10 characters');
                return;
            }

            if (firstMessage.length < 5) {
                showError('First message must be at least 5 characters');
                return;
            }

            try {
                button.disabled = true;
                button.textContent = 'Making Call...';
                
                console.log('Making call request:', { phone, prompt: prompt.substring(0, 50) + '...', firstMessage: firstMessage.substring(0, 50) + '...' });

                const response = await fetch(`${BASE_URL}/api/outbound-call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phone,
                        prompt: prompt,
                        first_message: firstMessage,
                        initData: initData
                    })
                });

                const data = await response.json();
                console.log('Call response:', data);

                if (response.ok && data.success) {
                    showSuccess(`Call initiated successfully! Call SID: ${data.call_sid}`);
                    
                    // Clear form
                    document.getElementById('callPhone').value = '';
                    document.getElementById('callPrompt').value = '';
                    document.getElementById('callMessage').value = '';
                    
                    // Reload stats and activity
                    setTimeout(() => {
                        loadStats();
                        loadActivity();
                    }, 1000);
                    
                    // Send data back to bot
                    if (tg && tg.sendData) {
                        tg.sendData(JSON.stringify({
                            action: 'call',
                            result: 'success',
                            call_sid: data.call_sid
                        }));
                    }
                } else {
                    throw new Error(data.error || 'Call failed');
                }
            } catch (error) {
                console.error('Call error:', error);
                showError(`Call failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üìû Make Call';
            }
        }

        // Handle SMS request
        async function handleSMS() {
            const button = document.getElementById('smsButton');
            const phone = document.getElementById('smsPhone').value.trim();
            const message = document.getElementById('smsMessage').value.trim();

            // Validation
            if (!phone || !message) {
                showError('Please fill in all fields');
                return;
            }

            if (!isValidPhone(phone)) {
                showError('Please enter a valid phone number (e.g., +1234567890)');
                return;
            }

            if (message.length > 1600) {
                showError('SMS message must be 1600 characters or less');
                return;
            }

            try {
                button.disabled = true;
                button.textContent = 'Sending SMS...';
                
                console.log('Making SMS request:', { phone, messageLength: message.length });

                const response = await fetch(`${BASE_URL}/api/send-sms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phone,
                        message: message,
                        initData: initData
                    })
                });

                const data = await response.json();
                console.log('SMS response:', data);

                if (response.ok && data.success) {
                    showSuccess(`SMS sent successfully! Message SID: ${data.message_sid}`);
                    
                    // Clear form
                    document.getElementById('smsPhone').value = '';
                    document.getElementById('smsMessage').value = '';
                    document.getElementById('smsCharCount').textContent = '0';
                    
                    // Reload stats and activity
                    setTimeout(() => {
                        loadStats();
                        loadActivity();
                    }, 1000);
                    
                    // Send data back to bot
                    if (tg && tg.sendData) {
                        tg.sendData(JSON.stringify({
                            action: 'sms',
                            result: 'success',
                            message_sid: data.message_sid
                        }));
                    }
                } else {
                    throw new Error(data.error || 'SMS failed');
                }
            } catch (error) {
                console.error('SMS error:', error);
                showError(`SMS failed: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'üì± Send SMS';
            }
        }

        // Utility functions
        function isValidPhone(phone) {
            const e164Regex = /^\+[1-9]\d{1,14}$/;
            return e164Regex.test(phone);
        }

        function showError(message) {
            showStatus(message, 'error');
        }

        function showSuccess(message) {
            showStatus(message, 'success');
        }

        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            container.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffHours < 48) return 'Yesterday';
            return date.toLocaleDateString();
        }

        // Handle Telegram Web App events
        if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.0')) {
            // Set theme colors
            if (tg.themeParams) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#007AFF');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            }
        }

        // Debug information
        console.log('Telegram WebApp initialized:', {
            version: tg.version,
            platform: tg.platform,
            initData: initData.substring(0, 50) + '...',
            user: user
        });
    </script>
</body>
</html>